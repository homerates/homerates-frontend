<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HomeRates.ai Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body { margin:0; background:#f9fafb; }
    header { background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px; font-weight:600; }
    #messages { height: calc(100vh - 130px); overflow:auto; padding:16px; }
    .msg { max-width:720px; padding:12px; border-radius:8px; margin:0 0 12px 0; white-space:pre-wrap; }
    .user { background:#2563eb; color:#fff; margin-left:auto; }
    .bot  { background:#fff; color:#111827; border:1px solid #e5e7eb; }
    form { display:flex; gap:8px; padding:12px; border-top:1px solid #e5e7eb; background:#fff; position:sticky; bottom:0; }
    input { flex:1; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; }
    button { background:#2563eb; color:#fff; border:none; border-radius:8px; padding:8px 16px; }
    .muted { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <header>HomeRates.ai Chat</header>
  <div class="muted" style="padding:8px 16px">
    <a href="/api/ping" target="_blank">/api/ping</a> ¬∑ <a href="/api/echo" target="_blank">/api/echo</a>
  </div>
  <div id="messages"></div>
  <form id="f">
    <input id="q" placeholder="Ask about mortgage rates, programs, or strategy‚Ä¶" autocomplete="off" />
    <button>Send</button>
  </form>
  <script>
    const msgs = document.getElementById('messages');
    const form = document.getElementById('f');
    const input = document.getElementById('q');

    let history = [
      { role:'assistant', content:"üëã Hi, I'm the HomeRates.ai assistant. How can I help?" }
    ];
    render();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      history.push({ role:'user', content:text });
      render();

      try {
        const r = await fetch('/api/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ messages: history })
        });

        const raw = await r.text();               // read raw text first
        let data;                                  // then try to parse
        try { data = JSON.parse(raw); } catch { data = null; }

        if (!r.ok) {
          const err = (data && data.error) ? data.error : raw || `HTTP ${r.status}`;
          history.push({ role:'assistant', content:'‚ö†Ô∏è ' + err });
        } else {
          const reply = (data && data.reply) ? data.reply : 'No reply';
          history.push({ role:'assistant', content: reply });
        }
      } catch (e) {
        history.push({ role:'assistant', content:'‚ö†Ô∏è Network error: ' + (e?.message || e) });
      }
      render();
    });

    function render() {
      msgs.innerHTML = '';
      for (const m of history) {
        const div = document.createElement('div');
        div.className = 'msg ' + (m.role === 'user' ? 'user':'bot');
        div.textContent = m.content;
        msgs.appendChild(div);
      }
      msgs.scrollTop = msgs.scrollHeight;
    }
  </script>
</body>
</html>
